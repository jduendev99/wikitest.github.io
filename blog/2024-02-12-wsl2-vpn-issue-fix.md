---
slug: wsl2-and-cisco-vpn-issue-fix
title: How to fix WSL2 & VPN issue
authors: anand
tags: [wsl,wsl2,vpn,cisco AnyConnect]
---

> How to fix WSL2 and Cisco Anyconnect VPN internet issue.

There is an issue with DNS Forwarding in *WSL2* /*WSL1* when using VPN (see [github Issue](https://github.com/microsoft/WSL/issues/1350)). Plus there is a issue with the *Cisco AnyConnect*. So here is a workaround for these problems. Should work for Ubuntu and Debian.

### The problem - some samples

* `sudo apt update` will display something similar below:

```bash showLineNumbers
Err:1 http://archive.ubuntu.com/ubuntu focal-updates InRelease
  Temporary failure resolving 'archive.ubuntu.com'
Err:2 http://archive.ubuntu.com/ubuntu focal-backports InRelease
  Temporary failure resolving 'archive.ubuntu.com'
Reading package lists... Done
W: Failed to fetch http://archive.ubuntu.com/ubuntu/dists/focal/InRelease  Temporary failure   resolving 'archive.ubuntu.com'
W: Failed to fetch http://archive.ubuntu.com/ubuntu/dists/focal-updates/InRelease  Temporary   failure resolving 'archive.ubuntu.com'
```

* `git pull` will display something similar below:

```bash
// code-block-error-line
fatal: unable to access 'https://github.com/actionanand/wiki.git/': Could not resolve host: github.com
```

* `ping google.com` will display something similar below:

```bash
ping: google.com: Temporary failure in name resolution
```
<!--truncate-->

Trying `sudo apt update`, `ping google.com`, `git pull`, etc on `wsl2` will fail when connected to Cisco Anyconnect VPN but without vpn it works fine. The problem is when you are connected to anyconnect(vpn), wsl fails to resolve the DNS.

## Workaround (new - automatic)
This solution is automatic and was created by [EdwardCooke](https://www.frakkingsweet.com/automatic-dns-configuration-with-wsl-and-anyconnect-client/). This is just the first part of his solution updating `resolv.conf` when starting WSL.

1. Re-enable auto generation of `resolv.conf` (if disabled) by commenting out (#)

```bash
sudo nano /etc/wsl.conf
```

```sh
#[network]
#generateResolvConf = false
```

2. Create the script

```sh
sudo nano /bin/vpn-dns.sh
```

```sh
#!/bin/bash

echo "Getting current DNS servers, this takes a couple of seconds"

/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe -Command '
$ErrorActionPreference="SilentlyContinue"
Get-NetAdapter -InterfaceDescription "Cisco AnyConnect*" | Get-DnsClientServerAddress | Select -ExpandProperty ServerAddresses
Get-NetAdapter | ?{-not ($_.InterfaceDescription -like "Cisco AnyConnect*") } | Get-DnsClientServerAddress | Select -ExpandProperty ServerAddresses
' | \
        awk 'BEGIN { print "# Generated by vpn fix func on", strftime("%c"); print } { print "nameserver", $1 }' | \
        tr -d '\r' > /etc/resolv.conf
clear
```

3. Make it executable/run as sudo

```sh
sudo chmod +x /bin/vpn-dns.sh
echo "$(whoami) ALL=(ALL) NOPASSWD: /bin/vpn-dns.sh" | sudo tee /etc/sudoers.d/010-$(whoami)-vpn-dns
```

4. Make it run on wsl startup

```sh
echo "sudo /bin/vpn-dns.sh" | sudo tee /etc/profile.d/vpn-dns.sh
```
Now restart the wsl & try `wget google.com` or `ping google.com`

5. If you don't want to auto run (step 4), You can also run it manually (You've to do every time)

```sh
sudo /bin/vpn-dns.sh
```

[For more details - StackOverflow](https://superuser.com/questions/1630487/no-internet-connection-ubuntu-wsl-while-vpn)

## Workaround (old manual)

Internet connection and DNS routing are broken from WSL2 instances, when some VPNs are active. The workaround breaks down into two steps:

### DNS Resolution

1. Having the Cisco Anyconnect VPN connected, you've to kick start powershell as Admin. Then fire the following commands to get all the available DNS/nameservers. Kindly take these DNS/nameservers down as we need them in later stage.

```powershell
Get-DnsClientServerAddress -AddressFamily IPv4 | Select-Object -ExpandProperty ServerAddresses
```

2. Next you can fire the folowing commands to get all the available search domains that will be needed later with the nameservers above.

```powershell
Get-DnsClientGlobalSetting | Select-Object -ExpandProperty SuffixSearchList
```

3. When the VPN is active, the autogenerated `/etc/resolv.conf` does not work. So the list of nameservers must be manually built to include some default DNS Name Servers and the DNS from the VPN.

First, disable automatically generating `/etc/resolv.conf`. And proceed in `wsl2` as described below:

```bash
  sudo unlink /etc/resolv.conf # this will unlink the default wsl2 resolv.conf
```

```bash title='/etc/resolv.conf'
  # This config will prevent wsl2 from overwritting the resolve.conf file everytime you start wsl2
  cat <<EOF | sudo tee -a /etc/wsl.conf
  [network]
  generateResolvConf = false
  EOF
```

Next, manually add the corportate DNS Server as the first `nameserver` in `/etc/resolv.conf`.

```bash title='/etc/resolv.conf'
cat <<EOF | sudo tee -a /etc/resolv.conf
nameserver 10.50... # The company DNS/nameserver from the command in step 1
nameserver 10.50... # The company DNS/nameserver from the command in step 1
nameserver 8.8.8.8
nameserver 8.8.4.4
search this.searchdomain.com # The search domain that we got from step 2
EOF
```

4. To prevent the system from re-writing your `/etc/resolv.conf` on startup of wsl, fire the below command in `wsl2`

```bash
sudo chattr +i /etc/resolv.conf
```

5. For extra information

To get `<corporateDNS>` addresses, use `ipconfig /all` from `CMD` or `Powershell` prompt, and check the details of the VPN adapter:

```powershell
Description . . . . . . . . . . . : Cisco AnyConnect Secure Mobility Client Virtual Miniport Adapter for Windows x64
Physical Address. . . . . . . . . : XX-XX-XX-XX-XX-XX
DHCP Enabled. . . . . . . . . . . : No
Autoconfiguration Enabled . . . . : Yes
IPv6 Address. . . . . . . . . . . : xxxx:xxxx:xxxx:xxxx(Preferred)
Link-local IPv6 Address . . . . . : xxxx:xxxx:xxxx:xxxx(Preferred)
IPv4 Address. . . . . . . . . . . : 10.20.30.40(Preferred)
Subnet Mask . . . . . . . . . . . : 255.255.255.255
Default Gateway . . . . . . . . . : ::
                                    0.0.0.0
DHCPv6 IAID . . . . . . . . . . . :
DHCPv6 Client DUID. . . . . . . . : 
DNS Servers . . . . . . . . . . . : 123.45.67.89    <- Corporate DNS 1
                                    123.45.67.90    <- Corporate DNS 2
Primary WINS Server . . . . . . . : xxx.xx.xxx.xx
NetBIOS over Tcpip. . . . . . . . : Enabled
```

### Network connection

When the VPN connection is active, network traffic out of WSL2 is not passed to the internet.

> Changing the Interface Metric 1 -> 6000 for AnyConnect VPN Adapter will resolve the connection issue. And  this has to be done each time after the VPN connection established.

By default, the Interface Metrics for AnyConnect are:
- IPv6: 6000
- IPv4: 1

`ping` times out from WSL Shell.

Changing the Interface Metrics as 600 for AnyConnect will reflect as below:
- IPv6: 6000
- IPv4: 6000

1. To chnage **Interface Metric 1 -> 6000**, fire the below command in powershell

```powershell
Get-NetAdapter | Where-Object {$_.InterfaceDescription -Match "Cisco AnyConnect"} | Set-NetIPInterface -InterfaceMetric 6000
```
:::tip
PS: The above command in powershell with admin rights, has to be fired each time after the VPN connection established
:::

2. Optional: 

Restart the `wsl2` from powershell using the below command or close the wsl2 window and reopen it.

```powershell
Restart-Service LxssManager
```

* [For more ...](https://gist.github.com/machuu/7663aa653828d81efbc2aaad6e3b1431)

## Hot Reload not working

### Fix for angular running on wsl2

The issue is because of [inotify](https://man7.org/linux/man-pages/man7/inotify.7.html), the Linux API used by hot reload, is not supported in WSL2 on 9P filesystem drives (e.g. Windows drives mounted into WSL2). So you can move your files inside `/home/your_linux_user_name/` directory of wsl(linux). And changing wsl2 to wsl1 will also fix the issue. The below fix is for all javascript projects including react. Here I've mentioned as angular, as I work on that.

    1. Open a terminal window.
    2. Navigate to the directory of your Angular project.
    3. Set the `CHOKIDAR_USEPOLLING` environment variable to `true` in env file. This will force Chokidar to use **polling** instead of watching for file changes.
    4. Start the Angular development server.

You can also achieve the same by firing the following command in wsl2 terminal inside the desired angular project as below:

```bash
export CHOKIDAR_USEPOLLING=true
ng serve
```

`CHOKIDAR_USEPOLLING` is an environment variable that is used to enable a polling mechanism for file watching. This is useful in situations where the default file watching mechanism does not work properly, such as when using Docker or WSL.

Once you have set `CHOKIDAR_USEPOLLING` to `true`, your Angular app will use a polling mechanism to watch for file changes. This means that it will periodically check for changes to your files, rather than relying on the operating system to notify it of changes.

Using CHOKIDAR_USEPOLLING can help to improve the reliability of hot reloading in Angular apps. However, it can also have a negative impact on performance, so it is only recommended to use it if you are experiencing problems with hot reloading. And **CHOKIDAR_USEPOLLING** is only supported in **Node.js versions 10 and above**.

## Bonus

### Not able to download RAW files too?

```bash
wget -O- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
--2022-12-28 13:02:52-- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
Resolving raw.githubusercontent.com (raw.githubusercontent.com)… 49.44.79.236, 2405:200:1607:2820:41::36
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|49.44.79.236|:443… failed: Connection timed out.
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|2405:200:1607:2820:41::36|:443… failed: Network is unreachable.
```

If you are in India and using the Jio network, you may face this as well because the ISP blocks the `raw.githubusercontent.com` at the DNS level for some unknown reason!


* Updating the `/etc/hosts` file in Linux & Windows or changing DNS or connecting to vpn will resolve the issue. Here we can see about updating `hosts` file.

1. For windows, Open `notepad` with admin, then click `file -> open` (`ctr+o`) and navigate to path **%SystemRoot%\System32\drivers\etc\hosts**

```bash
C:\System32\drivers\etc\hosts
```

Then, at the end of this file, add the IP address and the domain name as below:

```bash
185.199.110.133 raw.githubusercontent.com
```

Open the `/etc/hosts` file via nano or any editor in linux and mac and add the above code.

```bash
sudo nano /etc/hosts
```
